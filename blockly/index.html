<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="google" value="notranslate" />
    <title>Blockly Demo:</title>
    <script src="blockly_compressed.js"></script>
    <script src="blocks_compressed.js"></script>
    <script src="javascript_compressed.js"></script>
    <script src="msg/js/pt-br.js"></script>
    <script src="generatorblocks.js"></script>
    <script src="definitionblocks.js"></script>
    <style>
      body {
        background-color: #fff;
        font-family: sans-serif;
      }

      h1 {
        font-weight: normal;
        font-size: 140%;
      }

      #red {
        height: 30px;
        width: 30px;
        border-radius: 50%;
        background-color: white;
        border: solid 1px black;
      }
    </style>
  </head>

  <body>
    <p>
      <button onclick="showCode()">
        Show Javascrit
      </button>
      <button onclick="runCode()">
        Run Javascrit
      </button>
    </p>
    <div id="blocklyDiv" style="height: 800px; width: 900px;"></div>
    <xml id="toolbox" style="display: none;">
      <category name="Ação" colour="#5ba55b">
        <block type="move_frente"></block>
        <block type="move_tras"></block>
        <block type="vira_esquerda"></block>
        <block type="vira_direita"></block>
        <block type="faz_nada"></block>
        <block type="buzzer_freq"></block>
        <block type="buzzer_toca"></block>
        <block type="led_liga"></block>
        <block type="led_desliga"></block>
      </category>
      <category name="Lógica" colour="#745ba5">
        <block type="get_luminosidade"></block>
        <block type="get_umidade"></block>
        <block type="get_distancia"></block>
        <block type="get_temperatura"></block>
      </category>
      <category name="Helpers" colour="#a5755b">
        <block type="block_loop"></block>
        <block type="block_if"></block>
        <block type="block_if_else"></block>
        <block type="block_cond">
          <field name="comp">EQ</field>
        </block>
        <block type="block_math">
          <field name="op">PS</field>
        </block>
        <block type="math_number">
          <field name="NUM">123</field>
        </block>
      </category>
    </xml>
    <script>
      Array.prototype.last = function() {
        return this[this.length - 1];
      };
      var workspace = Blockly.inject("blocklyDiv", {
        media: "../../media",
        toolbox: document.getElementById("toolbox")
      });

      function showCode() {
        Blockly.JavaScript.INFINITE_LOOP_TRAP = null;
        var code = Blockly.JavaScript.workspaceToCode(workspace);
        let arr = code
          .split("\n")
          .filter(item => !(item === ""))
          .map(item => item.replace(/( *)/g, ""));
        let stack = [];
        for (let i = 0; i < arr.length; i++) {
          if (/(ne|je|jl|jg|ge|le)/gi.test(arr[i])) {
            stack.push(i);
          } else if (arr[i] == "FN$") {
            arr[stack.last()] = arr[stack.last()].replace("$", "") + i;
            arr[i] = arr[i].replace("$", "0");
            stack.pop();
          } else if (arr[i] == "JM$" && arr[i + 1] != 'FE$') {
            arr[i] = arr[i].replace("$", stack.last() - 2);
          } else if (arr[i-1] == "JM$" && arr[i] == "FE$") {
            arr[stack.last()] = arr[stack.last()] + i;
            arr[i] = "FN0"
            stack.pop();
            stack.push(i - 1)
          }

        }
    
        console.log(arr.map((item, index) => item.replace(/(?<=^..)(.*)/g, item => item.padStart(4, "0")) ).join(";")+";HT0000;$")
      }
    </script>
  </body>
</html>
